<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 6 Stochastic Treatment Regimes | Targeted Learning with the tlverse Software Ecosystem</title>
  <meta name="description" content="An open-source and fully-reproducible electronic set of teaching materials accompanying an invited short-course on applying Targeted Learning using the tlverse software ecosystem." />
  <meta name="generator" content="bookdown 0.16.5 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 6 Stochastic Treatment Regimes | Targeted Learning with the tlverse Software Ecosystem" />
  <meta property="og:type" content="book" />
  <meta property="og:url" content="https://tlverse.org/csp2020-workshop/" />
  
  <meta property="og:description" content="An open-source and fully-reproducible electronic set of teaching materials accompanying an invited short-course on applying Targeted Learning using the tlverse software ecosystem." />
  <meta name="github-repo" content="tlverse/csp2020-workshop" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 6 Stochastic Treatment Regimes | Targeted Learning with the tlverse Software Ecosystem" />
  
  <meta name="twitter:description" content="An open-source and fully-reproducible electronic set of teaching materials accompanying an invited short-course on applying Targeted Learning using the tlverse software ecosystem." />
  

<meta name="author" content="Mark van der Laan, Alan Hubbard, Jeremy Coyle, Nima Hejazi, Ivana Malenica, Rachael Phillips" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  <link rel="shortcut icon" href="img/logos/favicons/favicon.png" type="image/x-icon" />
<link rel="prev" href="optimal-individualized-treatment-regimes.html"/>
<link rel="next" href="r6.html"/>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<script src="libs/htmlwidgets-1.5.1/htmlwidgets.js"></script>
<link href="libs/vis-4.20.1/vis.css" rel="stylesheet" />
<script src="libs/vis-4.20.1/vis.min.js"></script>
<script src="libs/visNetwork-binding-2.0.9/visNetwork.js"></script>
<script src="libs/kePrint-0.0.1/kePrint.js"></script>


<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; position: absolute; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; }
pre.numberSource a.sourceLine:empty
  { position: absolute; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: absolute; left: -5em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="css/style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">CSP 2020 tlverse software workshop</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Preface</a><ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#important-links"><i class="fa fa-check"></i>Important links</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#about-this-workshop"><i class="fa fa-check"></i>About this workshop</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#outline"><i class="fa fa-check"></i>Outline</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#about-the-instructors-and-authors"><i class="fa fa-check"></i>About the instructors and authors</a><ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#mark-van-der-laan"><i class="fa fa-check"></i>Mark van der Laan</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#jeremy-coyle"><i class="fa fa-check"></i>Jeremy Coyle</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#alan-hubbard"><i class="fa fa-check"></i>Alan Hubbard</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#nima-hejazi"><i class="fa fa-check"></i>Nima Hejazi</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#ivana-malenica"><i class="fa fa-check"></i>Ivana Malenica</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#rachael-phillips"><i class="fa fa-check"></i>Rachael Phillips</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="" data-path="motivation.html"><a href="motivation.html"><i class="fa fa-check"></i>Motivation</a></li>
<li class="chapter" data-level="1" data-path="tlverse.html"><a href="tlverse.html"><i class="fa fa-check"></i><b>1</b> Welcome to the <code>tlverse</code></a><ul>
<li class="chapter" data-level="1.1" data-path="tlverse.html"><a href="tlverse.html#learning-objectives"><i class="fa fa-check"></i><b>1.1</b> Learning Objectives</a></li>
<li class="chapter" data-level="1.2" data-path="tlverse.html"><a href="tlverse.html#what-is-the-tlverse"><i class="fa fa-check"></i><b>1.2</b> What is the <code>tlverse</code>?</a></li>
<li class="chapter" data-level="1.3" data-path="tlverse.html"><a href="tlverse.html#tlverse-components"><i class="fa fa-check"></i><b>1.3</b> <code>tlverse</code> components</a></li>
<li class="chapter" data-level="1.4" data-path="tlverse.html"><a href="tlverse.html#installtlverse"><i class="fa fa-check"></i><b>1.4</b> Installation</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="intro.html"><a href="intro.html"><i class="fa fa-check"></i><b>2</b> The Targeted Learning Roadmap</a><ul>
<li class="chapter" data-level="2.1" data-path="intro.html"><a href="intro.html#the-statistical-model"><i class="fa fa-check"></i><b>2.1</b> The Statistical Model</a></li>
<li class="chapter" data-level="2.2" data-path="intro.html"><a href="intro.html#the-causal-model"><i class="fa fa-check"></i><b>2.2</b> The Causal Model</a></li>
<li class="chapter" data-level="2.3" data-path="intro.html"><a href="intro.html#the-parameter-of-interest"><i class="fa fa-check"></i><b>2.3</b> The Parameter of Interest</a></li>
<li class="chapter" data-level="2.4" data-path="intro.html"><a href="intro.html#identifiability"><i class="fa fa-check"></i><b>2.4</b> Identifiability</a></li>
<li class="chapter" data-level="2.5" data-path="intro.html"><a href="intro.html#estimation"><i class="fa fa-check"></i><b>2.5</b> Estimation</a><ul>
<li class="chapter" data-level="2.5.1" data-path="intro.html"><a href="intro.html#super-learning"><i class="fa fa-check"></i><b>2.5.1</b> Super Learning</a></li>
<li class="chapter" data-level="2.5.2" data-path="intro.html"><a href="intro.html#substitution-estimators"><i class="fa fa-check"></i><b>2.5.2</b> Substitution Estimators</a></li>
<li class="chapter" data-level="2.5.3" data-path="intro.html"><a href="intro.html#tmle"><i class="fa fa-check"></i><b>2.5.3</b> TMLE</a></li>
<li class="chapter" data-level="2.5.4" data-path="intro.html"><a href="intro.html#inference"><i class="fa fa-check"></i><b>2.5.4</b> Inference</a></li>
</ul></li>
<li class="chapter" data-level="2.6" data-path="intro.html"><a href="intro.html#the-wash-benefits-example-dataset"><i class="fa fa-check"></i><b>2.6</b> The WASH Benefits Example Dataset</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="ensemble-machine-learning.html"><a href="ensemble-machine-learning.html"><i class="fa fa-check"></i><b>3</b> Ensemble Machine Learning</a><ul>
<li class="chapter" data-level="3.1" data-path="ensemble-machine-learning.html"><a href="ensemble-machine-learning.html#learning-objectives-1"><i class="fa fa-check"></i><b>3.1</b> Learning Objectives</a></li>
<li class="chapter" data-level="3.2" data-path="ensemble-machine-learning.html"><a href="ensemble-machine-learning.html#introduction"><i class="fa fa-check"></i><b>3.2</b> Introduction</a></li>
<li class="chapter" data-level="3.3" data-path="ensemble-machine-learning.html"><a href="ensemble-machine-learning.html#basic-sl3-implementation"><i class="fa fa-check"></i><b>3.3</b> Basic <code>sl3</code> Implementation</a><ul>
<li class="chapter" data-level="" data-path="ensemble-machine-learning.html"><a href="ensemble-machine-learning.html#wash-benefits-study-example"><i class="fa fa-check"></i>WASH Benefits Study Example</a></li>
<li class="chapter" data-level="" data-path="ensemble-machine-learning.html"><a href="ensemble-machine-learning.html#load-the-necessary-libraries-and-data"><i class="fa fa-check"></i>0. Load the necessary libraries and data</a></li>
<li class="chapter" data-level="" data-path="ensemble-machine-learning.html"><a href="ensemble-machine-learning.html#define-the-machine-learning-task"><i class="fa fa-check"></i>1. Define the machine learning task</a></li>
<li class="chapter" data-level="" data-path="ensemble-machine-learning.html"><a href="ensemble-machine-learning.html#make-a-super-learner"><i class="fa fa-check"></i>2. Make a super learner</a></li>
<li class="chapter" data-level="" data-path="ensemble-machine-learning.html"><a href="ensemble-machine-learning.html#train-the-super-learner-on-the-machine-learning-task"><i class="fa fa-check"></i>3. Train the super learner on the machine learning task</a></li>
<li class="chapter" data-level="" data-path="ensemble-machine-learning.html"><a href="ensemble-machine-learning.html#obtain-predicted-values"><i class="fa fa-check"></i>4. Obtain predicted values</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="ensemble-machine-learning.html"><a href="ensemble-machine-learning.html#extensions"><i class="fa fa-check"></i><b>3.4</b> Extensions</a><ul>
<li class="chapter" data-level="3.4.1" data-path="ensemble-machine-learning.html"><a href="ensemble-machine-learning.html#cross-validated-super-learner"><i class="fa fa-check"></i><b>3.4.1</b> Cross-validated Super Learner</a></li>
<li class="chapter" data-level="3.4.2" data-path="ensemble-machine-learning.html"><a href="ensemble-machine-learning.html#variable-importance-measures-with-sl3"><i class="fa fa-check"></i><b>3.4.2</b> Variable Importance Measures with <code>sl3</code></a></li>
</ul></li>
<li class="chapter" data-level="3.5" data-path="ensemble-machine-learning.html"><a href="ensemble-machine-learning.html#exercise"><i class="fa fa-check"></i><b>3.5</b> Exercise</a><ul>
<li class="chapter" data-level="3.5.1" data-path="ensemble-machine-learning.html"><a href="ensemble-machine-learning.html#predicting-myocardial-infarction-with-sl3"><i class="fa fa-check"></i><b>3.5.1</b> Predicting Myocardial Infarction with <code>sl3</code></a></li>
</ul></li>
<li class="chapter" data-level="3.6" data-path="ensemble-machine-learning.html"><a href="ensemble-machine-learning.html#summary"><i class="fa fa-check"></i><b>3.6</b> Summary</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html"><i class="fa fa-check"></i><b>4</b> The TMLE Framework</a><ul>
<li class="chapter" data-level="4.1" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#learning-objectives-2"><i class="fa fa-check"></i><b>4.1</b> Learning Objectives</a></li>
<li class="chapter" data-level="4.2" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#easy-bake-example-tmle3-for-ate"><i class="fa fa-check"></i><b>4.2</b> Easy-Bake Example: <code>tmle3</code> for ATE</a><ul>
<li class="chapter" data-level="" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#load-the-data"><i class="fa fa-check"></i>0. Load the Data</a></li>
<li class="chapter" data-level="" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#define-the-variable-roles"><i class="fa fa-check"></i>1. Define the variable roles</a></li>
<li class="chapter" data-level="" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#create-a-spec-object"><i class="fa fa-check"></i>2. Create a “Spec” Object</a></li>
<li class="chapter" data-level="" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#define-the-relevant-super-learners"><i class="fa fa-check"></i>3. Define the Relevant Super Learners</a></li>
<li class="chapter" data-level="" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#fit-the-tmle"><i class="fa fa-check"></i>4. Fit the TMLE</a></li>
<li class="chapter" data-level="" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#evaluate-the-estimates"><i class="fa fa-check"></i>5. Evaluate the Estimates</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#tmle3-components"><i class="fa fa-check"></i><b>4.3</b> <code>tmle3</code> Components</a><ul>
<li class="chapter" data-level="4.3.1" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#tmle3_task"><i class="fa fa-check"></i><b>4.3.1</b> <code>tmle3_task</code></a></li>
<li class="chapter" data-level="4.3.2" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#initial-likelihood"><i class="fa fa-check"></i><b>4.3.2</b> Initial Likelihood</a></li>
<li class="chapter" data-level="4.3.3" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#targeted-likelihood-updater"><i class="fa fa-check"></i><b>4.3.3</b> Targeted Likelihood (updater)</a></li>
<li class="chapter" data-level="4.3.4" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#parameter-mapping"><i class="fa fa-check"></i><b>4.3.4</b> Parameter Mapping</a></li>
<li class="chapter" data-level="4.3.5" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#putting-it-all-together"><i class="fa fa-check"></i><b>4.3.5</b> Putting it all together</a></li>
</ul></li>
<li class="chapter" data-level="4.4" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#fitting-tmle3-with-multiple-parameters"><i class="fa fa-check"></i><b>4.4</b> Fitting <code>tmle3</code> with multiple parameters</a><ul>
<li class="chapter" data-level="4.4.1" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#delta-method"><i class="fa fa-check"></i><b>4.4.1</b> Delta Method</a></li>
<li class="chapter" data-level="4.4.2" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#fit"><i class="fa fa-check"></i><b>4.4.2</b> Fit</a></li>
</ul></li>
<li class="chapter" data-level="4.5" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#stratified-effect-estimates"><i class="fa fa-check"></i><b>4.5</b> Stratified Effect Estimates</a></li>
<li class="chapter" data-level="4.6" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#exercise-1"><i class="fa fa-check"></i><b>4.6</b> Exercise</a></li>
<li class="chapter" data-level="4.7" data-path="the-tmle-framework.html"><a href="the-tmle-framework.html#summary-1"><i class="fa fa-check"></i><b>4.7</b> Summary</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="optimal-individualized-treatment-regimes.html"><a href="optimal-individualized-treatment-regimes.html"><i class="fa fa-check"></i><b>5</b> Optimal Individualized Treatment Regimes</a><ul>
<li class="chapter" data-level="5.1" data-path="optimal-individualized-treatment-regimes.html"><a href="optimal-individualized-treatment-regimes.html#learning-objectives-3"><i class="fa fa-check"></i><b>5.1</b> Learning Objectives</a></li>
<li class="chapter" data-level="5.2" data-path="optimal-individualized-treatment-regimes.html"><a href="optimal-individualized-treatment-regimes.html#introduction-to-optimal-individualized-interventions"><i class="fa fa-check"></i><b>5.2</b> Introduction to Optimal Individualized Interventions</a></li>
<li class="chapter" data-level="5.3" data-path="optimal-individualized-treatment-regimes.html"><a href="optimal-individualized-treatment-regimes.html#data-structure-and-notation"><i class="fa fa-check"></i><b>5.3</b> Data Structure and Notation</a></li>
<li class="chapter" data-level="5.4" data-path="optimal-individualized-treatment-regimes.html"><a href="optimal-individualized-treatment-regimes.html#defining-the-causal-effect-of-an-optimal-individualized-intervention"><i class="fa fa-check"></i><b>5.4</b> Defining the Causal Effect of an Optimal Individualized Intervention</a><ul>
<li class="chapter" data-level="5.4.1" data-path="optimal-individualized-treatment-regimes.html"><a href="optimal-individualized-treatment-regimes.html#why-cv-tmle"><i class="fa fa-check"></i><b>5.4.1</b> Why CV-TMLE?</a></li>
</ul></li>
<li class="chapter" data-level="5.5" data-path="optimal-individualized-treatment-regimes.html"><a href="optimal-individualized-treatment-regimes.html#binary-treatment"><i class="fa fa-check"></i><b>5.5</b> Binary Treatment</a><ul>
<li class="chapter" data-level="5.5.1" data-path="optimal-individualized-treatment-regimes.html"><a href="optimal-individualized-treatment-regimes.html#evaluating-the-causal-effect-of-an-optimal-itr-with-binary-treatment"><i class="fa fa-check"></i><b>5.5.1</b> Evaluating the Causal Effect of an optimal ITR with Binary Treatment</a></li>
</ul></li>
<li class="chapter" data-level="5.6" data-path="optimal-individualized-treatment-regimes.html"><a href="optimal-individualized-treatment-regimes.html#categorical-treatment"><i class="fa fa-check"></i><b>5.6</b> Categorical Treatment</a><ul>
<li class="chapter" data-level="5.6.1" data-path="optimal-individualized-treatment-regimes.html"><a href="optimal-individualized-treatment-regimes.html#evaluating-the-causal-effect-of-an-optimal-itr-with-categorical-treatment"><i class="fa fa-check"></i><b>5.6.1</b> Evaluating the Causal Effect of an optimal ITR with Categorical Treatment</a></li>
</ul></li>
<li class="chapter" data-level="5.7" data-path="optimal-individualized-treatment-regimes.html"><a href="optimal-individualized-treatment-regimes.html#extensions-to-causal-effect-of-an-oit"><i class="fa fa-check"></i><b>5.7</b> Extensions to Causal Effect of an OIT</a><ul>
<li class="chapter" data-level="5.7.1" data-path="optimal-individualized-treatment-regimes.html"><a href="optimal-individualized-treatment-regimes.html#simpler-rules"><i class="fa fa-check"></i><b>5.7.1</b> Simpler Rules</a></li>
<li class="chapter" data-level="5.7.2" data-path="optimal-individualized-treatment-regimes.html"><a href="optimal-individualized-treatment-regimes.html#realistic-optimal-individual-regimes"><i class="fa fa-check"></i><b>5.7.2</b> Realistic Optimal Individual Regimes</a></li>
<li class="chapter" data-level="5.7.3" data-path="optimal-individualized-treatment-regimes.html"><a href="optimal-individualized-treatment-regimes.html#variable-importance-analysis"><i class="fa fa-check"></i><b>5.7.3</b> Variable Importance Analysis</a></li>
</ul></li>
<li class="chapter" data-level="5.8" data-path="optimal-individualized-treatment-regimes.html"><a href="optimal-individualized-treatment-regimes.html#exercise-2"><i class="fa fa-check"></i><b>5.8</b> Exercise</a><ul>
<li class="chapter" data-level="5.8.1" data-path="optimal-individualized-treatment-regimes.html"><a href="optimal-individualized-treatment-regimes.html#real-world-data-and-tmle3mopttx"><i class="fa fa-check"></i><b>5.8.1</b> Real World Data and <code>tmle3mopttx</code></a></li>
</ul></li>
<li class="chapter" data-level="5.9" data-path="optimal-individualized-treatment-regimes.html"><a href="optimal-individualized-treatment-regimes.html#summary-2"><i class="fa fa-check"></i><b>5.9</b> Summary</a><ul>
<li class="chapter" data-level="5.9.1" data-path="optimal-individualized-treatment-regimes.html"><a href="optimal-individualized-treatment-regimes.html#solutions"><i class="fa fa-check"></i><b>5.9.1</b> Solutions</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="stochastic-treatment-regimes.html"><a href="stochastic-treatment-regimes.html"><i class="fa fa-check"></i><b>6</b> Stochastic Treatment Regimes</a><ul>
<li class="chapter" data-level="6.1" data-path="stochastic-treatment-regimes.html"><a href="stochastic-treatment-regimes.html#learning-objectives-4"><i class="fa fa-check"></i><b>6.1</b> Learning Objectives</a></li>
<li class="chapter" data-level="6.2" data-path="stochastic-treatment-regimes.html"><a href="stochastic-treatment-regimes.html#introduction-1"><i class="fa fa-check"></i><b>6.2</b> Introduction</a></li>
<li class="chapter" data-level="6.3" data-path="stochastic-treatment-regimes.html"><a href="stochastic-treatment-regimes.html#stochastic-interventions"><i class="fa fa-check"></i><b>6.3</b> Stochastic Interventions</a><ul>
<li class="chapter" data-level="6.3.1" data-path="stochastic-treatment-regimes.html"><a href="stochastic-treatment-regimes.html#identifying-the-causal-effect-of-a-stochastic-intervention"><i class="fa fa-check"></i><b>6.3.1</b> Identifying the Causal Effect of a Stochastic Intervention</a></li>
<li class="chapter" data-level="6.3.2" data-path="stochastic-treatment-regimes.html"><a href="stochastic-treatment-regimes.html#interpreting-the-causal-effect-of-a-stochastic-intervention"><i class="fa fa-check"></i><b>6.3.2</b> Interpreting the Causal Effect of a Stochastic Intervention</a></li>
</ul></li>
<li class="chapter" data-level="6.4" data-path="stochastic-treatment-regimes.html"><a href="stochastic-treatment-regimes.html#estimating-the-causal-effect-of-a-stochastic-intervention-with-tmle3shift"><i class="fa fa-check"></i><b>6.4</b> Estimating the Causal Effect of a Stochastic Intervention with <code>tmle3shift</code></a><ul>
<li class="chapter" data-level="6.4.1" data-path="stochastic-treatment-regimes.html"><a href="stochastic-treatment-regimes.html#simulate-data-1"><i class="fa fa-check"></i><b>6.4.1</b> Simulate Data</a></li>
<li class="chapter" data-level="6.4.2" data-path="stochastic-treatment-regimes.html"><a href="stochastic-treatment-regimes.html#targeted-estimation-of-stochastic-interventions-effects"><i class="fa fa-check"></i><b>6.4.2</b> Targeted Estimation of Stochastic Interventions Effects</a></li>
</ul></li>
<li class="chapter" data-level="6.5" data-path="stochastic-treatment-regimes.html"><a href="stochastic-treatment-regimes.html#stochastic-interventions-over-a-grid-of-counterfactual-shifts"><i class="fa fa-check"></i><b>6.5</b> Stochastic Interventions over a Grid of Counterfactual Shifts</a><ul>
<li class="chapter" data-level="6.5.1" data-path="stochastic-treatment-regimes.html"><a href="stochastic-treatment-regimes.html#initializing-vimshift-through-its-tmle3_spec"><i class="fa fa-check"></i><b>6.5.1</b> Initializing <code>vimshift</code> through its <code>tmle3_Spec</code></a></li>
<li class="chapter" data-level="6.5.2" data-path="stochastic-treatment-regimes.html"><a href="stochastic-treatment-regimes.html#targeted-estimation-of-stochastic-intervention-effects"><i class="fa fa-check"></i><b>6.5.2</b> Targeted Estimation of Stochastic Intervention Effects</a></li>
<li class="chapter" data-level="6.5.3" data-path="stochastic-treatment-regimes.html"><a href="stochastic-treatment-regimes.html#inference-with-marginal-structural-models"><i class="fa fa-check"></i><b>6.5.3</b> Inference with Marginal Structural Models</a></li>
<li class="chapter" data-level="6.5.4" data-path="stochastic-treatment-regimes.html"><a href="stochastic-treatment-regimes.html#directly-targeting-the-msm-parameter-beta"><i class="fa fa-check"></i><b>6.5.4</b> Directly Targeting the MSM Parameter <span class="math inline">\(\beta\)</span></a></li>
<li class="chapter" data-level="6.5.5" data-path="stochastic-treatment-regimes.html"><a href="stochastic-treatment-regimes.html#example-with-the-wash-benefits-data"><i class="fa fa-check"></i><b>6.5.5</b> Example with the WASH Benefits Data</a></li>
</ul></li>
<li class="chapter" data-level="6.6" data-path="stochastic-treatment-regimes.html"><a href="stochastic-treatment-regimes.html#exercises"><i class="fa fa-check"></i><b>6.6</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="r6.html"><a href="r6.html"><i class="fa fa-check"></i><b>7</b> A Primer on the <code>R6</code> Class System</a><ul>
<li class="chapter" data-level="7.1" data-path="r6.html"><a href="r6.html#classes-fields-and-methods"><i class="fa fa-check"></i><b>7.1</b> Classes, Fields, and Methods</a></li>
<li class="chapter" data-level="7.2" data-path="r6.html"><a href="r6.html#object-oriented-programming-python-and-r"><i class="fa fa-check"></i><b>7.2</b> Object Oriented Programming: <code>Python</code> and <code>R</code></a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Targeted Learning with the <code>tlverse</code> Software Ecosystem</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="stochastic-treatment-regimes" class="section level1">
<h1><span class="header-section-number">Chapter 6</span> Stochastic Treatment Regimes</h1>
<p><em>Nima Hejazi</em></p>
<p>Based on the <a href="https://github.com/tlverse/tmle3shift"><code>tmle3shift</code> <code>R</code> package</a>
by <em>Nima Hejazi, Jeremy Coyle, and Mark van der Laan</em>.</p>
<p>Updated: 2020-01-08</p>
<div id="learning-objectives-4" class="section level2">
<h2><span class="header-section-number">6.1</span> Learning Objectives</h2>
<ol style="list-style-type: decimal">
<li>Differentiate stochastic treatment regimes from static, dynamic, and optimal
treatment regimes.</li>
<li>Describe how estimating causal effects of stochastic interventions informs a
real-world data analysis.</li>
<li>Contrast a population level stochastic intervention policy from a modified
treatment policy.</li>
<li>Estimate causal effects under stochastic treatment regimes with the
<code>tmle3shift</code> <code>R</code> package.</li>
<li>Specify a grid of counterfactual shift interventions to be used for defining
a set of stochastic intervention policies.</li>
<li>Interpret a set of effect estimates from a grid of counterfactual shift
interventions.</li>
<li>Construct marginal structural models to measure variable importance in terms
of stochastic interventions, using a grid of shift interventions.</li>
<li>Implement a shift intervention at the individual level, to facilitate
shifting each individual to a value that’s supported by the data.</li>
<li>Define novel shift intervention functions to extend the <code>tmle3shift</code> <code>R</code>
package.</li>
</ol>
</div>
<div id="introduction-1" class="section level2">
<h2><span class="header-section-number">6.2</span> Introduction</h2>
<p>In this section, we examine a simple example of stochastic treatment regimes in
the context of a continuous treatment variable of interest, defining an
intuitive causal effect through which to examine stochastic interventions more
generally. As a first step to using stochastic
treatment regimes in practice, we present the <a href="https://github.com/tlverse/tmle3shift"><code>tmle3shift</code> R
package</a>, which features an
implementation of a recently developed algorithm for computing targeted minimum
loss-based estimates of a causal effect based on a stochastic treatment regime
that shifts the natural value of the treatment based on a shifting function
<span class="math inline">\(d(A,W)\)</span>. We will also use <code>tmle3shift</code> to construct marginal structural models
for variable importance measures, implement shift interventions at the
individual level, and define novel shift intervention functions.</p>
</div>
<div id="stochastic-interventions" class="section level2">
<h2><span class="header-section-number">6.3</span> Stochastic Interventions</h2>
<ul>
<li>Present a relatively simple yet extremely flexible manner by which <em>realistic</em>
causal effects (and contrasts thereof) may be defined.</li>
<li>May be applied to nearly any manner of treatment variable – continuous,
ordinal, categorical, binary – allowing for a rich set of causal effects to
be defined through this formalism.</li>
<li><p>Arguably the most general of the classes of interventions through which causal
effects may be defined, and are conceptually simple.</p></li>
<li><p>We may consider stochastic interventions in two ways:</p>
<ol style="list-style-type: decimal">
<li><p>The equation <span class="math inline">\(f_A\)</span>, which produces <span class="math inline">\(A\)</span>, is replaced by a probabilistic
mechanism <span class="math inline">\(g_{\delta}(A \mid W)\)</span> that differs from the original <span class="math inline">\(g(A \mid W)\)</span>. The <em>stochastically modified</em> value of the treatment <span class="math inline">\(A_{\delta}\)</span> is
drawn from a user-specified distribution <span class="math inline">\(g_\delta(A \mid W)\)</span>, which may
depend on the original distribution <span class="math inline">\(g(A \mid W)\)</span> and is indexed by a
user-specified parameter <span class="math inline">\(\delta\)</span>. In this case, the stochastically
modified value of the treatment <span class="math inline">\(A_{\delta} \sim g_{\delta}(\cdot \mid W)\)</span>.</p></li>
<li><p>The observed value <span class="math inline">\(A\)</span> is replaced by a new value <span class="math inline">\(A_{d(A,W)}\)</span> based on
applying a user-defined function <span class="math inline">\(d(A,W)\)</span> to <span class="math inline">\(A\)</span>. In this case, the
stochastic treatment regime may be viewed as an intervention in which <span class="math inline">\(A\)</span>
is set equal to a value based on a hypothetical regime <span class="math inline">\(d(A, W)\)</span>, where
regime <span class="math inline">\(d\)</span> depends on the treatment level <span class="math inline">\(A\)</span> that would be assigned in the
absence of the regime as well as the covariates <span class="math inline">\(W\)</span>. Stochastic
interventions of this variety may be referred to as depending on the
<em>natural value of treatment</em> or as <em>modified treatment policies</em>
<span class="citation">(Haneuse and Rotnitzky <a href="#ref-haneuse2013estimation">2013</a>; Young, Hernán, and Robins <a href="#ref-young2014identification">2014</a>)</span>.</p></li>
</ol></li>
</ul>
<div id="identifying-the-causal-effect-of-a-stochastic-intervention" class="section level3">
<h3><span class="header-section-number">6.3.1</span> Identifying the Causal Effect of a Stochastic Intervention</h3>
<ul>
<li><p>The stochastic intervention generates a counterfactual random variable
<span class="math inline">\(Y_{d(A,W)} := f_Y(d(A,W), W, U_Y) \equiv Y_{g_{\delta}} := f_Y(A_{\delta}, W, U_Y)\)</span>, where <span class="math inline">\(Y_{d(A,W)} \sim \mathcal{P}_0^{\delta}\)</span>.</p></li>
<li><p>The target causal estimand of our analysis is <span class="math inline">\(\psi_{0, \delta} := \mathbb{E}_{P_0^{\delta}}\{Y_{d(A,W)}\}\)</span>, the mean of the counterfactual
outcome variable <span class="math inline">\(Y_{d(A, W)}\)</span>. The statistical target parameter may also be
denoted <span class="math inline">\(\Psi(P_0) = \mathbb{E}_{P_0}{\overline{Q}(d(A, W), W)}\)</span>, where
<span class="math inline">\(\overline{Q}(d(A, W), W)\)</span> is the counterfactual outcome value of a given
individual under the stochastic intervention distribution
<span class="citation">(Díaz and van der Laan <a href="#ref-diaz2018stochastic">2018</a>)</span>.</p></li>
<li><p>In prior work, <span class="citation">Díaz and van der Laan (<a href="#ref-diaz2012population">2012</a>)</span> showed that the causal quantity of interest
<span class="math inline">\(\mathbb{E}_0 \{Y_{d(A, W)}\}\)</span> is identified by a functional of the
distribution of <span class="math inline">\(O\)</span>:
<span class="math display">\[\begin{align*}\label{eqn:identification2012}
  \psi_{0,d} = \int_{\mathcal{W}} \int_{\mathcal{A}} &amp; \mathbb{E}_{P_0}
   \{Y \mid A = d(a, w), W = w\} \cdot \\ &amp;q_{0, A}^O(a \mid W = w) \cdot
   q_{0, W}^O(w) d\mu(a)d\nu(w).
\end{align*}\]</span></p></li>
<li><p>The four standard assumptions presented in  are necessary in order
to establish identifiability of the causal parameter from the observed data
via the statistical functional. These were</p>
<ol style="list-style-type: decimal">
<li><em>Consistency</em>: <span class="math inline">\(Y^{d(a_i, w_i)}_i = Y_i\)</span> in the event <span class="math inline">\(A_i = d(a_i, w_i)\)</span>,
for <span class="math inline">\(i = 1, \ldots, n\)</span></li>
<li><em>Stable unit value treatment assumption (SUTVA)</em>: <span class="math inline">\(Y^{d(a_i, w_i)}_i\)</span> does
not depend on <span class="math inline">\(d(a_j, w_j)\)</span> for <span class="math inline">\(i = 1, \ldots, n\)</span> and <span class="math inline">\(j \neq i\)</span>, or lack
of interference <span class="citation">(Rubin <a href="#ref-rubin1978bayesian">1978</a>, <a href="#ref-rubin1980randomization">1980</a>)</span>.</li>
<li><em>Strong ignorability</em>: <span class="math inline">\(A_i \perp \!\!\! \perp Y^{d(a_i, w_i)}_i \mid W_i\)</span>,
for <span class="math inline">\(i = 1, \ldots, n\)</span>.</li>
<li><em>Positivity (or overlap)</em>: <span class="math inline">\(a_i \in \mathcal{A} \implies d(a_i, w_i) \in \mathcal{A}\)</span> for all <span class="math inline">\(w \in \mathcal{W}\)</span>, where <span class="math inline">\(\mathcal{A}\)</span> denotes the
support of <span class="math inline">\(A \mid W = w_i \quad \forall i = 1, \ldots n\)</span>.</li>
</ol></li>
<li><p>With the identification assumptions satisfied, <span class="citation">Díaz and van der Laan (<a href="#ref-diaz2012population">2012</a>)</span> and
<span class="citation">Díaz and van der Laan (<a href="#ref-diaz2018stochastic">2018</a>)</span> provide an efficient influence function with respect to
the nonparametric model <span class="math inline">\(\mathcal{M}\)</span> as
<span class="math display">\[\begin{equation*}\label{eqn:eif}
  D(P_0)(x) = H(a, w)({y - \overline{Q}(a, w)}) +
  \overline{Q}(d(a, w), w) - \Psi(P_0),
\end{equation*}\]</span>
where the auxiliary covariate <span class="math inline">\(H(a,w)\)</span> may be expressed
<span class="math display">\[\begin{equation*}\label{eqn:aux_covar_full}
  H(a,w) = \mathbb{I}(a + \delta &lt; u(w)) \frac{g_0(a - \delta \mid w)} {g_0(a \mid w)}
    + \mathbb{I}(a + \delta \geq u(w)),
\end{equation*}\]</span>
which may be reduced to
<span class="math display">\[\begin{equation*}\label{eqn:aux_covar_simple}
  H(a,w) = \frac{g_0(a - \delta \mid w)}{g_0(a \mid w)} + 1
\end{equation*}\]</span>
in the case that the treatment is in the limits that arise from conditioning
on <span class="math inline">\(W\)</span>, i.e., for <span class="math inline">\(A_i \in (u(w) - \delta, u(w))\)</span>.</p></li>
</ul>
</div>
<div id="interpreting-the-causal-effect-of-a-stochastic-intervention" class="section level3">
<h3><span class="header-section-number">6.3.2</span> Interpreting the Causal Effect of a Stochastic Intervention</h3>
<div class="figure" style="text-align: center"><span id="fig:unnamed-chunk-3"></span>
<img src="img/gif/shift_animation.gif" alt="Animation of how a counterfactual outcome changes as the natural treatment distribution is subjected to a simple stochastic intervention" width="60%" />
<p class="caption">
Figure 6.1: Animation of how a counterfactual outcome changes as the natural treatment distribution is subjected to a simple stochastic intervention
</p>
</div>
</div>
</div>
<div id="estimating-the-causal-effect-of-a-stochastic-intervention-with-tmle3shift" class="section level2">
<h2><span class="header-section-number">6.4</span> Estimating the Causal Effect of a Stochastic Intervention with <code>tmle3shift</code></h2>
<p>We use <code>tmle3shift</code> to construct a targeted maximum likelihood (TML) estimator of
of a causal effect of a stochastic treatment regime that shifts the natural
value of the treatment based on a shifting function <span class="math inline">\(d(A,W)\)</span>. We will follow
the recipe provided by <span class="citation">Díaz and van der Laan (<a href="#ref-diaz2018stochastic">2018</a>)</span>, tailored to the <code>tmle3</code> framework:</p>
<ol style="list-style-type: decimal">
<li>Construct initial estimators <span class="math inline">\(g_n\)</span> of <span class="math inline">\(g_0(A, W)\)</span> and <span class="math inline">\(Q_n\)</span> of
<span class="math inline">\(\overline{Q}_0(A, W)\)</span>, perhaps using data-adaptive regression techniques.</li>
<li>For each observation <span class="math inline">\(i\)</span>, compute an estimate <span class="math inline">\(H_n(a_i, w_i)\)</span> of the
auxiliary covariate <span class="math inline">\(H(a_i,w_i)\)</span>.</li>
<li>Estimate the parameter <span class="math inline">\(\epsilon\)</span> in the logistic regression model
<span class="math display">\[ \text{logit}\overline{Q}_{\epsilon, n}(a, w) =
\text{logit}\overline{Q}_n(a, w) + \epsilon H_n(a, w),\]</span>
or an alternative regression model incorporating weights.</li>
<li>Compute TML estimator <span class="math inline">\(\Psi_n\)</span> of the target parameter, defining update
<span class="math inline">\(\overline{Q}_n^{\star}\)</span> of the initial estimate
<span class="math inline">\(\overline{Q}_{n, \epsilon_n}\)</span>:
<span class="math display">\[\begin{equation*}\label{eqn:tmle}
  \Psi_n = \Psi(P_n^{\star}) = \frac{1}{n} \sum_{i = 1}^n
  \overline{Q}_n^{\star}(d(A_i, W_i), W_i).
\end{equation*}\]</span></li>
</ol>
<p>To start, let’s load the packages we’ll use and set a seed for simulation:</p>
<div class="sourceCode" id="cb108"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb108-1" data-line-number="1"><span class="kw">library</span>(tidyverse)</a>
<a class="sourceLine" id="cb108-2" data-line-number="2"><span class="kw">library</span>(data.table)</a>
<a class="sourceLine" id="cb108-3" data-line-number="3"><span class="kw">library</span>(condensier)</a>
<a class="sourceLine" id="cb108-4" data-line-number="4"><span class="kw">library</span>(sl3)</a>
<a class="sourceLine" id="cb108-5" data-line-number="5"><span class="kw">library</span>(tmle3)</a>
<a class="sourceLine" id="cb108-6" data-line-number="6"><span class="kw">library</span>(tmle3shift)</a>
<a class="sourceLine" id="cb108-7" data-line-number="7"><span class="kw">set.seed</span>(<span class="dv">429153</span>)</a></code></pre></div>
<p><strong>1. Construct initial estimators <span class="math inline">\(g_n\)</span> of <span class="math inline">\(g_0(A, W)\)</span> and <span class="math inline">\(Q_n\)</span> of
<span class="math inline">\(\overline{Q}_0(A, W)\)</span>.</strong></p>
<p>We need to estimate two components of the likelihood in order to construct a
TML estimator.</p>
<ol style="list-style-type: decimal">
<li>The outcome regression, <span class="math inline">\(\hat{Q}_n\)</span>, which is a simple regression of the
form <span class="math inline">\(\mathbb{E}[Y \mid A,W]\)</span>.</li>
</ol>
<div class="sourceCode" id="cb109"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb109-1" data-line-number="1"><span class="co"># learners used for conditional expectation regression</span></a>
<a class="sourceLine" id="cb109-2" data-line-number="2">lrn_mean &lt;-<span class="st"> </span>Lrnr_mean<span class="op">$</span><span class="kw">new</span>()</a>
<a class="sourceLine" id="cb109-3" data-line-number="3">lrn_fglm &lt;-<span class="st"> </span>Lrnr_glm_fast<span class="op">$</span><span class="kw">new</span>()</a>
<a class="sourceLine" id="cb109-4" data-line-number="4">lrn_xgb &lt;-<span class="st"> </span>Lrnr_xgboost<span class="op">$</span><span class="kw">new</span>(<span class="dt">nrounds =</span> <span class="dv">200</span>)</a>
<a class="sourceLine" id="cb109-5" data-line-number="5">sl_lrn &lt;-<span class="st"> </span>Lrnr_sl<span class="op">$</span><span class="kw">new</span>(</a>
<a class="sourceLine" id="cb109-6" data-line-number="6">  <span class="dt">learners =</span> <span class="kw">list</span>(lrn_mean, lrn_fglm, lrn_xgb),</a>
<a class="sourceLine" id="cb109-7" data-line-number="7">  <span class="dt">metalearner =</span> Lrnr_nnls<span class="op">$</span><span class="kw">new</span>()</a>
<a class="sourceLine" id="cb109-8" data-line-number="8">)</a></code></pre></div>
<ol start="2" style="list-style-type: decimal">
<li>The treatment mechanism, <span class="math inline">\(\hat{g}_n\)</span>, i.e., the <em>propensity score</em>. In the
case of a continuous intervention, such a quantity is a conditional density.
Generally speaking, conditional density estimation is a challenging
problem that has received much attention in the literature. To estimate the
treatment mechanism, we must make use of learning algorithms specifically
suited to conditional density estimation; a list of such learners may be
extracted from <code>sl3</code> by using <code>sl3_list_learners()</code>:</li>
</ol>
<div class="sourceCode" id="cb110"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb110-1" data-line-number="1"><span class="kw">sl3_list_learners</span>(<span class="st">&quot;density&quot;</span>)</a></code></pre></div>
<pre><code>[1] &quot;Lrnr_condensier&quot;             &quot;Lrnr_density_discretize&quot;    
[3] &quot;Lrnr_density_hse&quot;            &quot;Lrnr_density_semiparametric&quot;
[5] &quot;Lrnr_haldensify&quot;             &quot;Lrnr_rfcde&quot;                 
[7] &quot;Lrnr_solnp_density&quot;         </code></pre>
<p>To proceed, we’ll select two of the above learners, <code>Lrnr_haldensify</code> for using
the highly adaptive lasso for conditional density estimation, based on an
algorithm given by <span class="citation">Díaz and van der Laan (<a href="#ref-diaz2011super">2011</a>)</span> and implemented in <span class="citation">Hejazi and Benkeser (<a href="#ref-hejazi2019haldensify">2019</a>)</span>, and
<code>Lrnr_rfcde</code>, an approach for using random forests for conditional density
estimation <span class="citation">(Pospisil and Lee <a href="#ref-pospisil2018rfcde">2018</a>)</span>. A Super Learner may be constructed by pooling
estimates from each of these modified conditional density regression techniques.</p>
<div class="sourceCode" id="cb112"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb112-1" data-line-number="1"><span class="co"># learners used for conditional density regression (i.e., propensity score)</span></a>
<a class="sourceLine" id="cb112-2" data-line-number="2">lrn_haldensify &lt;-<span class="st"> </span>Lrnr_haldensify<span class="op">$</span><span class="kw">new</span>(</a>
<a class="sourceLine" id="cb112-3" data-line-number="3">  <span class="dt">n_bins =</span> <span class="dv">5</span>, <span class="dt">grid_type =</span> <span class="st">&quot;equal_mass&quot;</span>,</a>
<a class="sourceLine" id="cb112-4" data-line-number="4">  <span class="dt">lambda_seq =</span> <span class="kw">exp</span>(<span class="kw">seq</span>(<span class="op">-</span><span class="dv">1</span>, <span class="dv">-13</span>, <span class="dt">length =</span> <span class="dv">500</span>))</a>
<a class="sourceLine" id="cb112-5" data-line-number="5">)</a>
<a class="sourceLine" id="cb112-6" data-line-number="6">lrn_rfcde &lt;-<span class="st"> </span>Lrnr_rfcde<span class="op">$</span><span class="kw">new</span>(</a>
<a class="sourceLine" id="cb112-7" data-line-number="7">  <span class="dt">n_trees =</span> <span class="dv">1000</span>, <span class="dt">node_size =</span> <span class="dv">5</span>,</a>
<a class="sourceLine" id="cb112-8" data-line-number="8">  <span class="dt">n_basis =</span> <span class="dv">31</span>, <span class="dt">output_type =</span> <span class="st">&quot;observed&quot;</span></a>
<a class="sourceLine" id="cb112-9" data-line-number="9">)</a>
<a class="sourceLine" id="cb112-10" data-line-number="10">sl_lrn_dens &lt;-<span class="st"> </span>Lrnr_sl<span class="op">$</span><span class="kw">new</span>(</a>
<a class="sourceLine" id="cb112-11" data-line-number="11">  <span class="dt">learners =</span> <span class="kw">list</span>(lrn_haldensify, lrn_rfcde),</a>
<a class="sourceLine" id="cb112-12" data-line-number="12">  <span class="dt">metalearner =</span> Lrnr_solnp_density<span class="op">$</span><span class="kw">new</span>()</a>
<a class="sourceLine" id="cb112-13" data-line-number="13">)</a></code></pre></div>
<p>Finally, we construct a <code>learner_list</code> object for use in constructing a TML
estimator of our target parameter of interest:</p>
<div class="sourceCode" id="cb113"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb113-1" data-line-number="1">Q_learner &lt;-<span class="st"> </span>sl_lrn</a>
<a class="sourceLine" id="cb113-2" data-line-number="2">g_learner &lt;-<span class="st"> </span>sl_lrn_dens</a>
<a class="sourceLine" id="cb113-3" data-line-number="3">learner_list &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">Y =</span> Q_learner, <span class="dt">A =</span> g_learner)</a></code></pre></div>
<div id="simulate-data-1" class="section level3">
<h3><span class="header-section-number">6.4.1</span> Simulate Data</h3>
<div class="sourceCode" id="cb114"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb114-1" data-line-number="1"><span class="co"># simulate simple data for tmle-shift sketch</span></a>
<a class="sourceLine" id="cb114-2" data-line-number="2">n_obs &lt;-<span class="st"> </span><span class="dv">1000</span> <span class="co"># number of observations</span></a>
<a class="sourceLine" id="cb114-3" data-line-number="3">tx_mult &lt;-<span class="st"> </span><span class="dv">2</span> <span class="co"># multiplier for the effect of W = 1 on the treatment</span></a>
<a class="sourceLine" id="cb114-4" data-line-number="4"></a>
<a class="sourceLine" id="cb114-5" data-line-number="5">## baseline covariates -- simple, binary</a>
<a class="sourceLine" id="cb114-6" data-line-number="6">W &lt;-<span class="st"> </span><span class="kw">replicate</span>(<span class="dv">2</span>, <span class="kw">rbinom</span>(n_obs, <span class="dv">1</span>, <span class="fl">0.5</span>))</a>
<a class="sourceLine" id="cb114-7" data-line-number="7"></a>
<a class="sourceLine" id="cb114-8" data-line-number="8">## create treatment based on baseline W</a>
<a class="sourceLine" id="cb114-9" data-line-number="9">A &lt;-<span class="st"> </span><span class="kw">rnorm</span>(n_obs, <span class="dt">mean =</span> tx_mult <span class="op">*</span><span class="st"> </span>W, <span class="dt">sd =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb114-10" data-line-number="10"></a>
<a class="sourceLine" id="cb114-11" data-line-number="11">## create outcome as a linear function of A, W + white noise</a>
<a class="sourceLine" id="cb114-12" data-line-number="12">Y &lt;-<span class="st"> </span><span class="kw">rbinom</span>(n_obs, <span class="dv">1</span>, <span class="dt">prob =</span> <span class="kw">plogis</span>(A <span class="op">+</span><span class="st"> </span>W))</a>
<a class="sourceLine" id="cb114-13" data-line-number="13"></a>
<a class="sourceLine" id="cb114-14" data-line-number="14"><span class="co"># organize data and nodes for tmle3</span></a>
<a class="sourceLine" id="cb114-15" data-line-number="15">data &lt;-<span class="st"> </span><span class="kw">data.table</span>(W, A, Y)</a>
<a class="sourceLine" id="cb114-16" data-line-number="16"><span class="kw">setnames</span>(data, <span class="kw">c</span>(<span class="st">&quot;W1&quot;</span>, <span class="st">&quot;W2&quot;</span>, <span class="st">&quot;A&quot;</span>, <span class="st">&quot;Y&quot;</span>))</a>
<a class="sourceLine" id="cb114-17" data-line-number="17">node_list &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">W =</span> <span class="kw">c</span>(<span class="st">&quot;W1&quot;</span>, <span class="st">&quot;W2&quot;</span>), <span class="dt">A =</span> <span class="st">&quot;A&quot;</span>, <span class="dt">Y =</span> <span class="st">&quot;Y&quot;</span>)</a>
<a class="sourceLine" id="cb114-18" data-line-number="18"><span class="kw">head</span>(data)</a></code></pre></div>
<pre><code>   W1 W2          A Y
1:  1  1  3.5806529 1
2:  1  0  3.2071846 1
3:  1  1  1.0358382 1
4:  0  0 -0.6578495 1
5:  1  1  3.0199033 1
6:  1  1  2.7803127 1</code></pre>
<p>We now have an observed data structure (<code>data</code>) and a specification of the role
that each variable in the data set plays as the nodes in a <em>directed acyclic
graph</em> (DAG) via <em>nonparametric structural equation models</em> (NPSEMs).</p>
<p>To start, we will initialize a specification for the TMLE of our parameter of
interest (a <code>tmle3_Spec</code> in the <code>tlverse</code> nomenclature) simply by calling
<code>tmle_shift</code>. We specify the argument <code>shift_val = 0.5</code> when initializing the
<code>tmle3_Spec</code> object to communicate that we’re interested in a shift of <span class="math inline">\(0.5\)</span> on
the scale of the treatment <span class="math inline">\(A\)</span> – that is, we specify <span class="math inline">\(\delta = 0.5\)</span>.</p>
<div class="sourceCode" id="cb116"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb116-1" data-line-number="1"><span class="co"># initialize a tmle specification</span></a>
<a class="sourceLine" id="cb116-2" data-line-number="2">tmle_spec &lt;-<span class="st"> </span><span class="kw">tmle_shift</span>(</a>
<a class="sourceLine" id="cb116-3" data-line-number="3">  <span class="dt">shift_val =</span> <span class="fl">0.5</span>,</a>
<a class="sourceLine" id="cb116-4" data-line-number="4">  <span class="dt">shift_fxn =</span> shift_additive_bounded,</a>
<a class="sourceLine" id="cb116-5" data-line-number="5">  <span class="dt">shift_fxn_inv =</span> shift_additive_bounded_inv</a>
<a class="sourceLine" id="cb116-6" data-line-number="6">)</a></code></pre></div>
<p>As seen above, the <code>tmle_shift</code> specification object (like all <code>tmle3_Spec</code>
objects) does <em>not</em> store the data for our specific analysis of interest. Later,
we’ll see that passing a data object directly to the <code>tmle3</code> wrapper function,
alongside the instantiated <code>tmle_spec</code>, will serve to construct a <code>tmle3_Task</code>
object internally (see the <code>tmle3</code> documentation for details).</p>
<p>Note that in the initialization of the <code>tmle3_Spec</code>, we specified a shifting
function <code>shift_additive_bounded</code> (and its inverse). This shifting function
corresponds to a stochastic regime slightly more complicated than that initially
considered in <span class="citation">Díaz and van der Laan (<a href="#ref-diaz2018stochastic">2018</a>)</span>. In particular, <code>shift_additive_bounded</code> is
encapsulates a procedure that determines an acceptable set of shifting values
for the shift <span class="math inline">\(\delta\)</span>, allowing for the observed treatment value of a given
observation to be shifted if the auxiliary covariate <span class="math inline">\(H_n\)</span> is bounded by a
constant and not shifting the given observation if this criterion does not
hold. We discuss this in greater detail in the sequel.</p>
</div>
<div id="targeted-estimation-of-stochastic-interventions-effects" class="section level3">
<h3><span class="header-section-number">6.4.2</span> Targeted Estimation of Stochastic Interventions Effects</h3>
<div class="sourceCode" id="cb117"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb117-1" data-line-number="1">tmle_fit &lt;-<span class="st"> </span><span class="kw">tmle3</span>(tmle_spec, data, node_list, learner_list)</a></code></pre></div>
<pre><code>
Iter: 1 fn: 1374.3703    Pars:  0.80650 0.19350
Iter: 2 fn: 1374.3703    Pars:  0.80651 0.19349
solnp--&gt; Completed in 2 iterations</code></pre>
<div class="sourceCode" id="cb119"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb119-1" data-line-number="1">tmle_fit</a></code></pre></div>
<pre><code>A tmle3_Fit that took 1 step(s)
   type         param  init_est  tmle_est         se     lower     upper
1:  TSM E[Y_{A=NULL}] 0.7957592 0.7970787 0.01231784 0.7729362 0.8212212
   psi_transformed lower_transformed upper_transformed
1:       0.7970787         0.7729362         0.8212212</code></pre>
<p>The <code>print</code> method of the resultant <code>tmle_fit</code> object conveniently displays the
results from computing our TML estimator.</p>
</div>
</div>
<div id="stochastic-interventions-over-a-grid-of-counterfactual-shifts" class="section level2">
<h2><span class="header-section-number">6.5</span> Stochastic Interventions over a Grid of Counterfactual Shifts</h2>
<ul>
<li><p>Consider an arbitrary scalar <span class="math inline">\(\delta\)</span> that defines a counterfactual outcome
<span class="math inline">\(\psi_n = Q_n(d(A, W), W)\)</span>, where, for simplicity, let <span class="math inline">\(d(A, W) = A + \delta\)</span>.
A simplified expression of the auxiliary covariate for the TMLE of <span class="math inline">\(\psi\)</span> is
<span class="math inline">\(H_n = \frac{g^{\star}(a \mid w)}{g(a \mid w)}\)</span>, where <span class="math inline">\(g^{\star}(a \mid w)\)</span>
defines the treatment mechanism with the stochastic intervention implemented.
In this manner, we can specify a <em>grid</em> of shifts <span class="math inline">\(\delta\)</span> to define a set of
stochastic intervention policies in an <em>a priori</em> manner.</p></li>
<li><p>To ascertain whether a given choice of the shift <span class="math inline">\(\delta\)</span> is acceptable, let
there be a bound <span class="math inline">\(C(\delta) = \frac{g^{\star}(a \mid w)}{g(a \mid w)} \leq M\)</span>,
where <span class="math inline">\(g^{\star}(a \mid w)\)</span> is a function of <span class="math inline">\(\delta\)</span> in part, and <span class="math inline">\(M\)</span> is a
user-specified upper bound of <span class="math inline">\(C(\delta)\)</span>. Then, <span class="math inline">\(C(\delta)\)</span> is a measure of
the influence of a given observation (under a bound of the ratio of the
conditional densities), which provides a way to limit the maximum influence of
a given observation through a choice of the shift <span class="math inline">\(\delta\)</span>.</p></li>
<li><p>For the purpose of using such a shift in practice, the present software
provides the functions <code>shift_additive_bounded</code> and
<code>shift_additive_bounded_inv</code>, which define a variation of this shift:
<span class="math display">\[\begin{equation}
  \delta(a, w) =
    \begin{cases}
      \delta, &amp; C(\delta) \leq M \\
      0, \text{otherwise} \\
    \end{cases},
\end{equation}\]</span>
which corresponds to an intervention in which the natural value of treatment
of a given observational unit is shifted by a value <span class="math inline">\(\delta\)</span> in the case that
the ratio of the intervened density <span class="math inline">\(g^{\star}(a \mid w)\)</span> to the natural
density <span class="math inline">\(g(a \mid w)\)</span> (that is, <span class="math inline">\(C(\delta)\)</span>) does not exceed a bound <span class="math inline">\(M\)</span>. In
the case that the ratio <span class="math inline">\(C(\delta)\)</span> exceeds the bound <span class="math inline">\(M\)</span>, the stochastic
intervention policy does not apply to the given unit and they remain at their
natural value of treatment <span class="math inline">\(a\)</span>.</p></li>
</ul>
<div id="initializing-vimshift-through-its-tmle3_spec" class="section level3">
<h3><span class="header-section-number">6.5.1</span> Initializing <code>vimshift</code> through its <code>tmle3_Spec</code></h3>
<p>To start, we will initialize a specification for the TMLE of our parameter of
interest (called a <code>tmle3_Spec</code> in the <code>tlverse</code> nomenclature) simply by calling
<code>tmle_shift</code>. We specify the argument <code>shift_grid = seq(-1, 1, by = 1)</code>
when initializing the <code>tmle3_Spec</code> object to communicate that we’re interested
in assessing the mean counterfactual outcome over a grid of shifts -1, 0, 1 on the scale of the treatment <span class="math inline">\(A\)</span>.</p>
<div class="sourceCode" id="cb121"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb121-1" data-line-number="1"><span class="co"># what&#39;s the grid of shifts we wish to consider?</span></a>
<a class="sourceLine" id="cb121-2" data-line-number="2">delta_grid &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="dt">from =</span> <span class="dv">-1</span>, <span class="dt">to =</span> <span class="dv">1</span>, <span class="dt">by =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb121-3" data-line-number="3"></a>
<a class="sourceLine" id="cb121-4" data-line-number="4"><span class="co"># initialize a tmle specification</span></a>
<a class="sourceLine" id="cb121-5" data-line-number="5">tmle_spec &lt;-<span class="st"> </span><span class="kw">tmle_vimshift_delta</span>(</a>
<a class="sourceLine" id="cb121-6" data-line-number="6">  <span class="dt">shift_grid =</span> delta_grid,</a>
<a class="sourceLine" id="cb121-7" data-line-number="7">  <span class="dt">max_shifted_ratio =</span> <span class="dv">2</span></a>
<a class="sourceLine" id="cb121-8" data-line-number="8">)</a></code></pre></div>
</div>
<div id="targeted-estimation-of-stochastic-intervention-effects" class="section level3">
<h3><span class="header-section-number">6.5.2</span> Targeted Estimation of Stochastic Intervention Effects</h3>
<p>One may walk through the step-by-step procedure for fitting the TML estimator
of the mean counterfactual outcome under each shift in the grid, using the
machinery exposed by the <a href="https://tlverse.org/tmle3"><code>tmle3</code> R package</a>, or
simply invoke the <code>tmle3</code> wrapper function to fit the series of TML estimators
(one for each parameter defined by the grid delta) in a single function call.
For convenience, we choose the latter:</p>
<div class="sourceCode" id="cb122"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb122-1" data-line-number="1">tmle_fit &lt;-<span class="st"> </span><span class="kw">tmle3</span>(tmle_spec, data, node_list, learner_list)</a></code></pre></div>
<pre><code>
Iter: 1 fn: 1377.4289    Pars:  0.78447 0.21553
Iter: 2 fn: 1377.4289    Pars:  0.78448 0.21552
solnp--&gt; Completed in 2 iterations</code></pre>
<div class="sourceCode" id="cb124"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb124-1" data-line-number="1">tmle_fit</a></code></pre></div>
<pre><code>A tmle3_Fit that took 1 step(s)
         type          param  init_est  tmle_est         se      lower
1:        TSM  E[Y_{A=NULL}] 0.6278879 0.6328067 0.01418175 0.60501097
2:        TSM  E[Y_{A=NULL}] 0.7388461 0.7390000 0.01389504 0.71176623
3:        TSM  E[Y_{A=NULL}] 0.8424598 0.8379178 0.01067431 0.81699652
4: MSM_linear MSM(intercept) 0.7363979 0.7365748 0.01232697 0.71241442
5: MSM_linear     MSM(slope) 0.1072860 0.1025555 0.00449215 0.09375109
       upper psi_transformed lower_transformed upper_transformed
1: 0.6606024       0.6328067        0.60501097         0.6606024
2: 0.7662338       0.7390000        0.71176623         0.7662338
3: 0.8588390       0.8379178        0.81699652         0.8588390
4: 0.7607352       0.7365748        0.71241442         0.7607352
5: 0.1113600       0.1025555        0.09375109         0.1113600</code></pre>
<p><em>Remark</em>: The <code>print</code> method of the resultant <code>tmle_fit</code> object conveniently
displays the results from computing our TML estimator.</p>
</div>
<div id="inference-with-marginal-structural-models" class="section level3">
<h3><span class="header-section-number">6.5.3</span> Inference with Marginal Structural Models</h3>
<p>Since we consider estimating the mean counterfactual outcome <span class="math inline">\(\psi_n\)</span> under
several values of the intervention <span class="math inline">\(\delta\)</span>, taken from the aforementioned
<span class="math inline">\(\delta\)</span>-grid, one approach for obtaining inference on a single summary measure
of these estimated quantities involves leveraging working marginal structural
models (MSMs). Summarizing the estimates <span class="math inline">\(\psi_n\)</span> through a working MSM allows
for inference on the <em>trend</em> imposed by a <span class="math inline">\(\delta\)</span>-grid to be evaluated via a
simple hypothesis test on a parameter of this working MSM. Letting
<span class="math inline">\(\psi_{\delta}(P_0)\)</span> be the mean outcome under a shift <span class="math inline">\(\delta\)</span> of the
treatment, we have <span class="math inline">\(\vec{\psi}_{\delta} = (\psi_{\delta}: \delta)\)</span> with
corresponding estimators <span class="math inline">\(\vec{\psi}_{n, \delta} = (\psi_{n, \delta}: \delta)\)</span>.
Further, let <span class="math inline">\(\beta(\vec{\psi}_{\delta}) = \phi((\psi_{\delta}: \delta))\)</span>. By a
straightforward application of the delta method (discussed previously), we may
write the efficient influence function of the MSM parameter <span class="math inline">\(\beta\)</span> in terms of
the EIFs of each of the corresponding point estimates. Based on this, inference
from a working MSM is rather straightforward. To wit, the limiting distribution
for <span class="math inline">\(m_{\beta}(\delta)\)</span> may be expressed <span class="math display">\[\sqrt{n}(\beta_n - \beta_0) \to N(0,
\Sigma),\]</span> where <span class="math inline">\(\Sigma\)</span> is the empirical covariance matrix of
<span class="math inline">\(\text{EIF}_{\beta}(O)\)</span>.</p>
<div class="sourceCode" id="cb126"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb126-1" data-line-number="1">tmle_fit<span class="op">$</span>summary[<span class="dv">4</span><span class="op">:</span><span class="dv">5</span>, ]</a></code></pre></div>
<pre><code>         type          param  init_est  tmle_est         se      lower
1: MSM_linear MSM(intercept) 0.7363979 0.7365748 0.01232697 0.71241442
2: MSM_linear     MSM(slope) 0.1072860 0.1025555 0.00449215 0.09375109
       upper psi_transformed lower_transformed upper_transformed
1: 0.7607352       0.7365748        0.71241442         0.7607352
2: 0.1113600       0.1025555        0.09375109         0.1113600</code></pre>
</div>
<div id="directly-targeting-the-msm-parameter-beta" class="section level3">
<h3><span class="header-section-number">6.5.4</span> Directly Targeting the MSM Parameter <span class="math inline">\(\beta\)</span></h3>
<p>Note that in the above, a working MSM is fit to the individual TML estimates of
the mean counterfactual outcome under a given value of the shift <span class="math inline">\(\delta\)</span> in
the supplied grid. The parameter of interest <span class="math inline">\(\beta\)</span> of the MSM is
asymptotically linear (and, in fact, a TML estimator) as a consequence of its
construction from individual TML estimators. In smaller samples, it may be
prudent to perform a TML estimation procedure that targets the parameter
<span class="math inline">\(\beta\)</span> directly, as opposed to constructing it from several independently
targeted TML estimates. An approach for constructing such an estimator is
proposed in the sequel.</p>
<p>Suppose a simple working MSM <span class="math inline">\(\mathbb{E}Y_{g^0_{\delta}} = \beta_0 + \beta_1 \delta\)</span>, then a TML estimator targeting <span class="math inline">\(\beta_0\)</span> and <span class="math inline">\(\beta_1\)</span> may be
constructed as
<span class="math display">\[\overline{Q}_{n, \epsilon}(A,W) = \overline{Q}_n(A,W) + \epsilon (H_1(g),
H_2(g),\]</span> for all <span class="math inline">\(\delta\)</span>, where <span class="math inline">\(H_1(g)\)</span> is the auxiliary covariate for
<span class="math inline">\(\beta_0\)</span> and <span class="math inline">\(H_2(g)\)</span> is the auxiliary covariate for <span class="math inline">\(\beta_1\)</span>.</p>
<p>To construct a targeted maximum likelihood estimator that directly targets the
parameters of the working marginal structural model, we may use the
<code>tmle_vimshift_msm</code> Spec (instead of the <code>tmle_vimshift_delta</code> Spec that
appears above):</p>
<div class="sourceCode" id="cb128"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb128-1" data-line-number="1"><span class="co"># initialize a tmle specification</span></a>
<a class="sourceLine" id="cb128-2" data-line-number="2">tmle_msm_spec &lt;-<span class="st"> </span><span class="kw">tmle_vimshift_msm</span>(</a>
<a class="sourceLine" id="cb128-3" data-line-number="3">  <span class="dt">shift_grid =</span> delta_grid,</a>
<a class="sourceLine" id="cb128-4" data-line-number="4">  <span class="dt">max_shifted_ratio =</span> <span class="dv">2</span></a>
<a class="sourceLine" id="cb128-5" data-line-number="5">)</a>
<a class="sourceLine" id="cb128-6" data-line-number="6"></a>
<a class="sourceLine" id="cb128-7" data-line-number="7"><span class="co"># fit the TML estimator and examine the results</span></a>
<a class="sourceLine" id="cb128-8" data-line-number="8">tmle_msm_fit &lt;-<span class="st"> </span><span class="kw">tmle3</span>(tmle_msm_spec, data, node_list, learner_list)</a></code></pre></div>
<pre><code>
Iter: 1 fn: 1382.4163    Pars:  0.77373 0.22627
Iter: 2 fn: 1382.4163    Pars:  0.77373 0.22627
solnp--&gt; Completed in 2 iterations</code></pre>
<div class="sourceCode" id="cb130"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb130-1" data-line-number="1">tmle_msm_fit</a></code></pre></div>
<pre><code>A tmle3_Fit that took 100 step(s)
         type          param  init_est  tmle_est          se      lower
1: MSM_linear MSM(intercept) 0.7364961 0.7368318 0.012332674 0.71266018
2: MSM_linear     MSM(slope) 0.1082668 0.1082033 0.004554628 0.09927641
       upper psi_transformed lower_transformed upper_transformed
1: 0.7610034       0.7368318        0.71266018         0.7610034
2: 0.1171302       0.1082033        0.09927641         0.1171302</code></pre>
</div>
<div id="example-with-the-wash-benefits-data" class="section level3">
<h3><span class="header-section-number">6.5.5</span> Example with the WASH Benefits Data</h3>
<p>To complete our walk through, let’s turn to using stochastic interventions to
investigate the data from the WASH Benefits trial. To start, let’s load the
data, convert all columns to be of class <code>numeric</code>, and take a quick look at it</p>
<div class="sourceCode" id="cb132"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb132-1" data-line-number="1">washb_data &lt;-<span class="st"> </span><span class="kw">fread</span>(<span class="st">&quot;https://raw.githubusercontent.com/tlverse/tlverse-data/master/wash-benefits/washb_data_subset.csv&quot;</span>, <span class="dt">stringsAsFactors =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb132-2" data-line-number="2">washb_data &lt;-<span class="st"> </span>washb_data[<span class="op">!</span><span class="kw">is.na</span>(momage) <span class="op">&amp;</span><span class="st"> </span><span class="op">!</span><span class="kw">is.na</span>(momheight), ]</a>
<a class="sourceLine" id="cb132-3" data-line-number="3"><span class="kw">head</span>(washb_data, <span class="dv">3</span>)</a></code></pre></div>
<pre><code>     whz          tr fracode month aged    sex momage         momedu momheight
1: -0.94 Handwashing  N06505     7  237   male     21 Primary (1-5y)    146.00
2: -1.13     Control  N06505     8  310 female     26   No education    148.90
3: -1.61     Control  N06524     3  162   male     25 Primary (1-5y)    153.75
       hfiacat Nlt18 Ncomp watmin elec floor walls roof asset_wardrobe
1: Food Secure     1    25      2    1     0     1    1              0
2: Food Secure     1     7      4    1     0     0    1              0
3: Food Secure     0    15      2    0     0     1    1              0
   asset_table asset_chair asset_khat asset_chouki asset_tv asset_refrig
1:           1           0          0            1        0            0
2:           1           1          0            1        0            0
3:           1           0          1            1        0            0
   asset_bike asset_moto asset_sewmach asset_mobile
1:          0          0             0            0
2:          0          0             0            1
3:          0          0             0            0</code></pre>
<p>Next, we specify our NPSEM via the <code>node_list</code> object. For our example analysis,
we’ll consider the outcome to be the weight-for-height Z-score (as in previous
sections), the intervention of interest to be the mother’s age at time of
child’s birth, and take all other covariates to be potential confounders.</p>
<div class="sourceCode" id="cb134"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb134-1" data-line-number="1">node_list &lt;-<span class="st"> </span><span class="kw">list</span>(</a>
<a class="sourceLine" id="cb134-2" data-line-number="2">  <span class="dt">W =</span> <span class="kw">names</span>(washb_data)[<span class="op">!</span>(<span class="kw">names</span>(washb_data) <span class="op">%in%</span></a>
<a class="sourceLine" id="cb134-3" data-line-number="3"><span class="st">    </span><span class="kw">c</span>(<span class="st">&quot;whz&quot;</span>, <span class="st">&quot;momage&quot;</span>))],</a>
<a class="sourceLine" id="cb134-4" data-line-number="4">  <span class="dt">A =</span> <span class="st">&quot;momage&quot;</span>, <span class="dt">Y =</span> <span class="st">&quot;whz&quot;</span></a>
<a class="sourceLine" id="cb134-5" data-line-number="5">)</a></code></pre></div>
<p>Were we to consider the counterfactual weight-for-height Z-score under shifts in
the age of the mother at child’s birth, how would we interpret estimates of our
parameter?</p>
<p>To simplify our interpretation, consider a shift (up or down) of two years in
the mother’s age (i.e., <span class="math inline">\(\delta = \{-2, 0, 2\}\)</span>); in this setting, a stochastic
intervention would correspond to a policy advocating that potential mothers
defer or accelerate plans of having a child for two calendar years, possibly
implemented through the deployment of an encouragement design.</p>
<p>First, let’s try a simple upward shift of just two years:</p>
<div class="sourceCode" id="cb135"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb135-1" data-line-number="1"><span class="co"># initialize a tmle specification for just a single delta shift</span></a>
<a class="sourceLine" id="cb135-2" data-line-number="2">washb_shift_spec &lt;-<span class="st"> </span><span class="kw">tmle_shift</span>(</a>
<a class="sourceLine" id="cb135-3" data-line-number="3">  <span class="dt">shift_val =</span> <span class="dv">2</span>,</a>
<a class="sourceLine" id="cb135-4" data-line-number="4">  <span class="dt">shift_fxn =</span> shift_additive,</a>
<a class="sourceLine" id="cb135-5" data-line-number="5">  <span class="dt">shift_fxn_inv =</span> shift_additive_inv</a>
<a class="sourceLine" id="cb135-6" data-line-number="6">)</a></code></pre></div>
<p>To examine the effect modification approach we looked at in previous chapters,
we’ll estimate the effect of this shift <span class="math inline">\(\delta = 2\)</span> while stratifying on the
mother’s education level (<code>momedu</code>, a categorical variable with three levels).
For this, we augment our initialized <code>tmle3_Spec</code> object like so</p>
<div class="sourceCode" id="cb136"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb136-1" data-line-number="1"><span class="co"># initialize effect modification specification around previous specification</span></a>
<a class="sourceLine" id="cb136-2" data-line-number="2">washb_shift_strat_spec &lt;-<span class="st">  </span><span class="kw">tmle_stratified</span>(washb_shift_spec, <span class="st">&quot;momedu&quot;</span>)</a></code></pre></div>
<p>Prior to running our analysis, we’ll modify the <code>learner_list</code> object we had
created such that the density estimation procedure we rely on will be only the
random forest conditional density estimation procedure of <span class="citation">Pospisil and Lee (<a href="#ref-pospisil2018rfcde">2018</a>)</span>, as
the nonparametric conditional density approach based on the highly adaptive
lasso <span class="citation">(Díaz and van der Laan <a href="#ref-diaz2011super">2011</a>; Benkeser and van der Laan <a href="#ref-benkeser2016hal">2016</a>; Coyle and Hejazi <a href="#ref-coyle2018hal9001">2018</a>; Hejazi and Benkeser <a href="#ref-hejazi2019haldensify">2019</a>)</span> is currently unable to accommodate large datasets.</p>
<div class="sourceCode" id="cb137"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb137-1" data-line-number="1"><span class="co"># learners used for conditional density regression (i.e., propensity score)</span></a>
<a class="sourceLine" id="cb137-2" data-line-number="2">lrn_rfcde &lt;-<span class="st"> </span>Lrnr_rfcde<span class="op">$</span><span class="kw">new</span>(</a>
<a class="sourceLine" id="cb137-3" data-line-number="3">  <span class="dt">n_trees =</span> <span class="dv">1000</span>, <span class="dt">node_size =</span> <span class="dv">5</span>,</a>
<a class="sourceLine" id="cb137-4" data-line-number="4">  <span class="dt">n_basis =</span> <span class="dv">31</span>, <span class="dt">output_type =</span> <span class="st">&quot;observed&quot;</span></a>
<a class="sourceLine" id="cb137-5" data-line-number="5">)</a>
<a class="sourceLine" id="cb137-6" data-line-number="6"></a>
<a class="sourceLine" id="cb137-7" data-line-number="7"><span class="co"># we need to turn on cross-validation for the RFCDE learner</span></a>
<a class="sourceLine" id="cb137-8" data-line-number="8">lrn_cv_rfcde &lt;-<span class="st"> </span>Lrnr_cv<span class="op">$</span><span class="kw">new</span>(</a>
<a class="sourceLine" id="cb137-9" data-line-number="9">  <span class="dt">learner =</span> lrn_rfcde,</a>
<a class="sourceLine" id="cb137-10" data-line-number="10">  <span class="dt">full_fit =</span> <span class="ot">TRUE</span></a>
<a class="sourceLine" id="cb137-11" data-line-number="11">)</a>
<a class="sourceLine" id="cb137-12" data-line-number="12"></a>
<a class="sourceLine" id="cb137-13" data-line-number="13"><span class="co"># modify learner list, using existing SL for Q fit</span></a>
<a class="sourceLine" id="cb137-14" data-line-number="14">learner_list &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">Y =</span> sl_lrn, <span class="dt">A =</span> lrn_cv_rfcde)</a></code></pre></div>
<p>Now we’re ready to construct a TML estimate of the shift parameter at
<span class="math inline">\(\delta = 2\)</span>, stratified across levels of our variable of interest:</p>
<div class="sourceCode" id="cb138"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb138-1" data-line-number="1"><span class="co"># fit stratified TMLE</span></a>
<a class="sourceLine" id="cb138-2" data-line-number="2">washb_shift_strat_fit &lt;-<span class="st"> </span><span class="kw">tmle3</span>(washb_shift_strat_spec, washb_data, node_list,</a>
<a class="sourceLine" id="cb138-3" data-line-number="3">                               learner_list)</a>
<a class="sourceLine" id="cb138-4" data-line-number="4">washb_shift_strat_fit</a></code></pre></div>
<pre><code>A tmle3_Fit that took 1 step(s)
             type                             param   init_est   tmle_est
1:            TSM                     E[Y_{A=NULL}] -0.5709154 -0.5738587
2: stratified TSM  E[Y_{A=NULL}] | V=Primary (1-5y) -0.5976481 -0.6261401
3: stratified TSM    E[Y_{A=NULL}] | V=No education -0.6297533 -0.8864402
4: stratified TSM E[Y_{A=NULL}] | V=Secondary (&gt;5y) -0.5372329 -0.4505694
           se      lower      upper psi_transformed lower_transformed
1: 0.05623153 -0.6840705 -0.4636469      -0.5738587        -0.6840705
2: 0.09661657 -0.8155051 -0.4367751      -0.6261401        -0.8155051
3: 0.16706956 -1.2138905 -0.5589899      -0.8864402        -1.2138905
4: 0.07362609 -0.5948739 -0.3062649      -0.4505694        -0.5948739
   upper_transformed
1:        -0.4636469
2:        -0.4367751
3:        -0.5589899
4:        -0.3062649</code></pre>
<p>For the next example, we’ll use the variable importance strategy of considering
a grid of stochastic interventions to evaluate the weight-for-height Z-score
under a shift in the mother’s age down by two years (<span class="math inline">\(\delta = -2\)</span>) through up
by two years (<span class="math inline">\(\delta = 2\)</span>), incrementing by a single year between the two. To
do this, we simply initialize a <code>Spec</code> <code>tmle_vimshift_delta</code> similar to how we
did in a previous example:</p>
<div class="sourceCode" id="cb140"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb140-1" data-line-number="1"><span class="co"># initialize a tmle specification for the variable importance parameter</span></a>
<a class="sourceLine" id="cb140-2" data-line-number="2">washb_vim_spec &lt;-<span class="st"> </span><span class="kw">tmle_vimshift_delta</span>(</a>
<a class="sourceLine" id="cb140-3" data-line-number="3">  <span class="dt">shift_grid =</span> <span class="kw">seq</span>(<span class="dt">from =</span> <span class="dv">-2</span>, <span class="dt">to =</span> <span class="dv">2</span>, <span class="dt">by =</span> <span class="dv">1</span>),</a>
<a class="sourceLine" id="cb140-4" data-line-number="4">  <span class="dt">max_shifted_ratio =</span> <span class="dv">2</span></a>
<a class="sourceLine" id="cb140-5" data-line-number="5">)</a></code></pre></div>
<p>Having made the above preparations, we’re now ready to estimate the
counterfactual mean of the weight-for-height Z-score under a small grid of
shifts in the mother’s age at child’s birth. Just as before, we do this through
a simple call to our <code>tmle3</code> wrapper function:</p>
<div class="sourceCode" id="cb141"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb141-1" data-line-number="1">washb_tmle_fit &lt;-<span class="st"> </span><span class="kw">tmle3</span>(washb_vim_spec, washb_data, node_list, learner_list)</a>
<a class="sourceLine" id="cb141-2" data-line-number="2">washb_tmle_fit</a></code></pre></div>
<pre><code>A tmle3_Fit that took 1 step(s)
         type          param     init_est     tmle_est          se       lower
1:        TSM  E[Y_{A=NULL}] -0.560989603 -0.566297320 0.042641969 -0.64987404
2:        TSM  E[Y_{A=NULL}] -0.563514251 -0.552819022 0.045689353 -0.64236851
3:        TSM  E[Y_{A=NULL}] -0.566049183 -0.565294117 0.046631440 -0.65669006
4:        TSM  E[Y_{A=NULL}] -0.568584115 -0.547040375 0.048264638 -0.64163733
5:        TSM  E[Y_{A=NULL}] -0.571119047 -0.556804968 0.048123756 -0.65112580
6: MSM_linear MSM(intercept) -0.566051240 -0.557651160 0.044707609 -0.64527646
7: MSM_linear     MSM(slope) -0.002532875  0.002476335 0.007074136 -0.01138872
         upper psi_transformed lower_transformed upper_transformed
1: -0.48272060    -0.566297320       -0.64987404       -0.48272060
2: -0.46326954    -0.552819022       -0.64236851       -0.46326954
3: -0.47389817    -0.565294117       -0.65669006       -0.47389817
4: -0.45244342    -0.547040375       -0.64163733       -0.45244342
5: -0.46248414    -0.556804968       -0.65112580       -0.46248414
6: -0.47002586    -0.557651160       -0.64527646       -0.47002586
7:  0.01634139     0.002476335       -0.01138872        0.01634139</code></pre>
<hr />
</div>
</div>
<div id="exercises" class="section level2">
<h2><span class="header-section-number">6.6</span> Exercises</h2>
<ol style="list-style-type: decimal">
<li><p>Set the <code>sl3</code> library of algorithms for the Super Learner to a simple,
interpretable library and use this new library to estimate the counterfactual
mean of mother’s age at child’s birth (<code>momage</code>) under a shift <span class="math inline">\(\delta = 0\)</span>.
What does this counterfactual mean equate to in terms of the observed data?</p></li>
<li><p>Describe two (equivalent) ways in which the causal effects of stochastic
interventions may be interpreted.</p></li>
<li><p>Using a grid of values of the shift parameter <span class="math inline">\(\delta\)</span> (e.g., <span class="math inline">\(\{-1, 0, +1\}\)</span>), repeat the analysis on the variable of interest (<code>momage</code>),
summarizing the trend for this sequence of shifts using a marginal structural
model.</p></li>
<li><p>For either the grid of shifts in the example preceding the exercises or that
estimated in (3) above, plot the resultant estimates against their respective
counterfactual shifts. Graphically add to the scatterplot a line with slope
and intercept equivalent to the MSM fit through the individual TML estimates.</p></li>
<li><p>How does the marginal structural model we used to summarize the trend along
the sequence of shifts previously help to contextualize the estimated effect
for a single shift? That is, how does access to estimates across several
shifts and the marginal structural model parameters allow us to more richly
interpret our findings?</p></li>
</ol>

</div>
</div>
<h3>References</h3>
<div id="refs" class="references">
<div id="ref-benkeser2016hal">
<p>Benkeser, David, and Mark J van der Laan. 2016. “The Highly Adaptive Lasso Estimator.” In <em>2016 IEEE International Conference on Data Science and Advanced Analytics (DSAA)</em>. IEEE. <a href="https://doi.org/10.1109/dsaa.2016.93" class="uri">https://doi.org/10.1109/dsaa.2016.93</a>.</p>
</div>
<div id="ref-coyle2018hal9001">
<p>Coyle, Jeremy R, and Nima S Hejazi. 2018. “hal9001: The Scalable Highly Adaptive LASSO.” <a href="https://github.com/tlverse/hal9001" class="uri">https://github.com/tlverse/hal9001</a>.</p>
</div>
<div id="ref-diaz2011super">
<p>Díaz, Iván, and Mark J van der Laan. 2011. “Super Learner Based Conditional Density Estimation with Application to Marginal Structural Models.” <em>The International Journal of Biostatistics</em> 7 (1). De Gruyter: 1–20.</p>
</div>
<div id="ref-diaz2012population">
<p>Díaz, Iván, and Mark J van der Laan. 2012. “Population Intervention Causal Effects Based on Stochastic Interventions.” <em>Biometrics</em> 68 (2). Wiley Online Library: 541–49.</p>
</div>
<div id="ref-diaz2018stochastic">
<p>Díaz, Iván, and Mark J van der Laan. 2018. “Stochastic Treatment Regimes.” In <em>Targeted Learning in Data Science: Causal Inference for Complex Longitudinal Studies</em>, 167–80. Springer Science &amp; Business Media.</p>
</div>
<div id="ref-haneuse2013estimation">
<p>Haneuse, Sebastian, and Andrea Rotnitzky. 2013. “Estimation of the Effect of Interventions That Modify the Received Treatment.” <em>Statistics in Medicine</em> 32 (30). Wiley Online Library: 5260–77.</p>
</div>
<div id="ref-hejazi2019haldensify">
<p>Hejazi, Nima S, and David C Benkeser. 2019. <em>haldensify: Nonparametric Conditional Density Estimation with the Highly Adaptive Lasso in R</em>. <a href="https://github.com/nhejazi/haldensify" class="uri">https://github.com/nhejazi/haldensify</a>.</p>
</div>
<div id="ref-pospisil2018rfcde">
<p>Pospisil, Taylor, and Ann B Lee. 2018. “RFCDE: Random Forests for Conditional Density Estimation.” <em>arXiv Preprint arXiv:1804.05753</em>.</p>
</div>
<div id="ref-rubin1978bayesian">
<p>Rubin, Donald B. 1978. “Bayesian Inference for Causal Effects: The Role of Randomization.” <em>The Annals of Statistics</em>. JSTOR, 34–58.</p>
</div>
<div id="ref-rubin1980randomization">
<p>Rubin, Donald B. 1980. “Randomization Analysis of Experimental Data: The Fisher Randomization Test Comment.” <em>Journal of the American Statistical Association</em> 75 (371). JSTOR: 591–93.</p>
</div>
<div id="ref-young2014identification">
<p>Young, Jessica G, Miguel A Hernán, and James M Robins. 2014. “Identification, Estimation and Approximation of Risk Under Interventions That Depend on the Natural Value of Treatment Using Observational Data.” <em>Epidemiologic Methods</em> 3 (1). De Gruyter: 1–19.</p>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="optimal-individualized-treatment-regimes.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="r6.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": true,
"facebook": false,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/tlverse/csp2020-workshop/edit/master/07-tmle3shift.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
